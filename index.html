<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternum PDF Generator</title>
    <style>
        button {
            margin: 10px; /* Add spacing between buttons */
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            font-size: 16px;
            color: blue;
        }
        #download-link {
            margin-top: 20px;
            display: block;
            font-size: 16px;
            color: green;
        }
    </style>
</head>
<body>
    <h1>Eternum PDF Generator</h1>
    <p>Select a chapter to generate the PDF:</p>
    <div id="buttons-container">
        <button onclick="generatePDF(0)">Chapter 0</button>
        <button onclick="generatePDF(1)">Chapter 1</button>
        <button onclick="generatePDF(2)">Chapter 2</button>
        <button onclick="generatePDF(3)">Chapter 3</button>
        <button onclick="generatePDF(4)">Chapter 4</button>
        <button onclick="generatePDF(5)">Chapter 5</button>
        <button onclick="generatePDF(6)">Chapter 6</button>
        <button onclick="generatePDF(7)">Chapter 7</button>
    </div>
    <p id="status"></p>
    <a id="download-link"></a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const coverImagePath = 'cover_image.png';

        const chapters = [
            { textFile: 'chapter0.txt', metadataFile: 'chapter0_meta.json' },
            { textFile: 'chapter1.txt', metadataFile: 'chapter1_meta.json' },
            { textFile: 'chapter2.txt', metadataFile: 'chapter2_meta.json' },
            { textFile: 'chapter3.txt', metadataFile: 'chapter3_meta.json' },
            { textFile: 'chapter4.txt', metadataFile: 'chapter4_meta.json' },
            { textFile: 'chapter5.txt', metadataFile: 'chapter5_meta.json' },
            { textFile: 'chapter6.txt', metadataFile: 'chapter6_meta.json' },
            { textFile: 'chapter7.txt', metadataFile: 'chapter7_meta.json' },
        ];

        async function fetchJSON(filePath) {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`Failed to load ${filePath}`);
            return response.json();
        }

        async function fetchText(filePath) {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`Failed to load ${filePath}`);
            return response.text();
        }

        async function fetchCoverImage(imgPath) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = imgPath;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = () => reject(new Error('Failed to load image.'));
            });
        }

        function text(line, str, x, y, opt, doc, chr, dim) {
            if (chr > 99) chr = 0;
            lines = line % 80;
            if (line && lines === 0 && chr === 0 && !newPage) {
                doc.addPage("p", "pt", dim);
                newPage = true;
            } else if (lines) newPage = false;
            doc.text('\n'.repeat(lines) + ' '.repeat(chr) + str, x, y, opt);
            return chr + str.length;
        }

        async function generatePDF(chapterIndex) {
            try {
                // Show loading status
                document.getElementById('status').innerText = `Generating PDF for Chapter ${chapterIndex}...`;
                document.getElementById('download-link').innerText = '';  // Clear any existing download link

                const { jsPDF } = window.jspdf;
                const chapter = chapters[chapterIndex];
                
                // Fetch text and metadata
                const chapterText = await fetchText(chapter.textFile);
                const metadata = await fetchJSON(chapter.metadataFile);
                const colors = await fetchJSON('Eternum.json'); // Fetch Eternum.json once

                // Fetch and add the cover image
                const coverImageData = await fetchCoverImage(coverImagePath);
                const doc = new jsPDF("p", "pt", [904, 1280]);
                doc.addImage(coverImageData, 'PNG', 1, 2, 904, 1280);

                // Add new page for content
                doc.addPage("p", "pt", [904, 1280]);
                doc.setFont("Courier");
                doc.setFontSize(13);
                const margin = { top: 30, right: 30, bottom: 30, left: 30 };
                const layout = { align: "left", maxWidth: 900 };

                let line = 0;
                let chr = 0;
                
                for (let i = 0; i < chapterText.length; i += 100, line++) {
                    const lineno = line.toString();
                    if (metadata[lineno]) {
                        const [user, n] = metadata[lineno];
                        const color = colors[user];
                        doc.setTextColor(color !== '#FFFFFF' ? color : '#CCCCCC');
                        chr = text(line, chapterText.slice(i, i + n), margin.left, margin.top, layout, doc, chr, [904, 1280]);
                        doc.setTextColor(0, 0, 0);
                        chr = text(line, chapterText.slice(i + n, i + 100), margin.left, margin.top, layout, doc, chr, [904, 1280]);
                    } else {
                        chr = text(line, chapterText.slice(i, i + 100), margin.left, margin.top, layout, doc, chr, [904, 1280]);
                    }
                }

                // Show download option
                const pdfBlob = doc.output('blob');
                const downloadLink = document.getElementById('download-link');
                downloadLink.href = URL.createObjectURL(pdfBlob);
                downloadLink.download = `chapter_${chapterIndex}.pdf`;
                downloadLink.textContent = `Download Chapter ${chapterIndex}`;
                downloadLink.style.display = 'block';  // Ensure the download link is visible
                
                // Update status
                document.getElementById('status').innerText = `PDF for Chapter ${chapterIndex} generated successfully!`;
            } catch (error) {
                document.getElementById('status').innerText = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>