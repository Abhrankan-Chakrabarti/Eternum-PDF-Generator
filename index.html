<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternum PDF Generator</title>
    <style>
        button {
            margin: 10px; /* Add spacing between buttons */
            padding: 10px;
            font-size: 16px;
        }
        #loading {
            display: none;
            margin-top: 20px;
            font-size: 18px;
            color: blue;
        }
        #download-links {
            margin-top: 20px;
        }
        #download-links a {
            display: block;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Select a Chapter to Generate PDF</h1>
    <button onclick="generatePDF(0)">Generate Chapter 0 PDF</button>
    <button onclick="generatePDF(1)">Generate Chapter 1 PDF</button>
    <button onclick="generatePDF(2)">Generate Chapter 2 PDF</button>
    <button onclick="generatePDF(3)">Generate Chapter 3 PDF</button>
    <button onclick="generatePDF(4)">Generate Chapter 4 PDF</button>
    <button onclick="generatePDF(5)">Generate Chapter 5 PDF</button>
    <button onclick="generatePDF(6)">Generate Chapter 6 PDF</button>
    <button onclick="generatePDF(7)">Generate Chapter 7 PDF</button>

    <div id="loading">Generating PDF, please wait...</div>
    <div id="download-links"></div>

    <script src="jspdf.umd.min.js"></script>
    <script>
        async function fetchResource(file) {
            const response = await fetch(file);
            if (!response.ok) throw new Error(`Failed to fetch ${file}`);
            return await response.text();
        }

        async function generatePDF(chapter) {
            const { jsPDF } = window.jspdf;
            const chapterFile = `chapters/chapter${chapter}.txt`;
            const metadataFile = `chapters/metadata${chapter}.json`;
            const coverImageFile = 'chapters/cover_image.png';

            document.getElementById('loading').style.display = 'block';

            try {
                const textContent = await fetchResource(chapterFile);
                const metadataContent = await fetchResource(metadataFile);
                const metadata = JSON.parse(metadataContent);
                const colorData = await fetchResource('eternum.json');
                const colorMap = JSON.parse(colorData);

                const img = new Image();
                img.src = coverImageFile;
                img.onload = () => {
                    const doc = new jsPDF('p', 'pt', [904, 1280]);
                    doc.addImage(img, 'PNG', 0, 0, 904, 1280);
                    doc.addPage('p', 'pt', [904, 1280]);
                    doc.setFont('Courier');
                    doc.setFontSize(13);

                    const margin = { top: 30, right: 30, bottom: 30, left: 30 };
                    const layout = { align: 'left', maxWidth: 900 };
                    let chr = 0;
                    let line = 0;

                    for (let i = 0; i < textContent.length; i += 100, line++) {
                        const lineNumber = line.toString();
                        if (lineNumber in metadata) {
                            const user = metadata[lineNumber][0];
                            const numChars = metadata[lineNumber][1];
                            const color = colorMap[user];
                            doc.setTextColor(color !== '#FFFFFF' ? color : '#CCCCCC');
                            chr = addText(line, textContent.slice(i, i + numChars), margin.left, margin.top, layout, doc, chr, [904, 1280]);
                            doc.setTextColor(0, 0, 0);
                            chr = addText(line, textContent.slice(i + numChars, i + 100), margin.left, margin.top, layout, doc, chr, [904, 1280]);
                        } else {
                            chr = addText(line, textContent.slice(i, i + 100), margin.left, margin.top, layout, doc, chr, [904, 1280]);
                        }
                    }

                    // Add footers
                    addFooters(doc);

                    // Show download link with a meaningful name
                    const fileName = `Chapter_${chapter}.pdf`; // Descriptive file name
                    const pdfData = doc.output('bloburl');
                    const link = document.createElement('a');
                    link.href = pdfData;
                    link.download = fileName; // Set the filename here
                    link.textContent = `Download ${fileName}`;
                    document.getElementById('download-links').appendChild(link);

                    document.getElementById('loading').style.display = 'none';
                };

            } catch (error) {
                console.error('Error:', error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Function to add footers to all pages
        function addFooters(doc) {
            const pageCount = doc.getNumberOfPages();
            doc.setFontSize(15); // Larger font size for clarity

            for (let i = 2; i <= pageCount; i++) {
                doc.setPage(i);

                // Get current page width and height
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Calculate X and Y coordinates for the footer text
                const x = pageWidth / 2;  // Center the text horizontally
                const y = pageHeight - 20; // 20 units from the bottom

                // Add the footer text, center-aligned
                doc.text(`Page ${i} of ${pageCount}`, x, y, { align: 'center' });
            }
        }

        // The unchanged addText function
        function addText(line, str, x, y, opt, doc, chr, dim) {
            if (chr > 99) chr = 0;
            const lines = line % 80;
            let newPage = false;
            if (line && lines === 0 && chr === 0 && !newPage) {
                doc.addPage("p", "pt", dim);
                newPage = true;
            } else if (lines) {
                newPage = false;
            }
            doc.text('\n'.repeat(lines) + ' '.repeat(chr) + str, x, y, opt);
            return chr + str.length;
        }
    </script>
</body>
</html>